{% extends 'gira/base.html' %}

{% block content %}
<div id="main-content" class="container my-0">

{% if gira %}
  <div class="text-start position-relative" style="width:100%; margin-top: 0.5rem;">

    <!-- Linha de setas bem próxima à navbar -->
    <div class="d-flex justify-content-between align-items-center mb-0" style="margin-top:0.3rem;">
      <button id="prevGira" class="btn btn-link p-0" title="Gira anterior"
              style="color:#bbb; background:transparent; border:none;">
        <i class="bi bi-chevron-left" style="font-size:1.3rem;"></i>
      </button>

      <button id="nextGira" class="btn btn-link p-0" title="Próxima gira"
              style="color:#bbb; background:transparent; border:none;">
        <i class="bi bi-chevron-right" style="font-size:1.3rem;"></i>
      </button>
    </div>

    <!-- Data e linha -->
    <p id="gira-data" class="mb-1 mt-1"
       style="font-size: 0.9rem; font-weight: 500;
              color: {% if tema == 'exu' %}#ff4d4d{% else %}#0072bb{% endif %};">
      {{ gira.data_hora|date:"d/m/Y H:i" }}
    </p>

    <h2 id="gira-linha" class="mb-1"
        style="font-size: 1.5rem; font-weight: 700;
               color: {% if tema == 'exu' %}#c00000{% else %}#222222{% endif %};">
      {{ gira.linha }}
    </h2>

    <!-- Frase fixa -->
    <p class="mb-0"
       style="font-size: 0.9rem;
              color: {% if tema == 'exu' %}#d0d0d0{% else %}#444444{% endif %};">
      Escolha ou visualize as funções assumidas para esta gira.<br>
      Cambones e responsáveis de cada área estão listados abaixo.
    </p>

  </div>
{% else %}
  <div class="alert alert-warning">Nenhuma gira encontrada.</div>
{% endif %}

<hr id="sep-1" class="my-4"
    style="border-color: {% if tema == 'exu' %}#660000{% else %}#cccccc{% endif %};">

<!-- BLOCO CAMBONES (template) -->
<section class="mb-5">
  <h4 id="title-cambones" class="mb-3"
      style="font-size: 1.3rem; font-weight: 600;
             color: {% if tema == 'exu' %}#b00000{% else %}#2e2e2e{% endif %};">
    Cambones
  </h4>

  <div id="cambones-container" class="row g-3">
    {% for f in cambones %}
      <div id="card-{{ f.chave }}" data-funcao="{{ f.chave }}"
           data-pessoa="{{ f.pessoa.id|default:'' }}"
           data-medium-de-linha-id="{{ f.medium_de_linha.id|default:'' }}"
           class="col-6 col-md-4 col-lg-3">
        <div class="card border-0 shadow-sm {% if tema == 'exu' %}bg-light{% else %}bg-body-tertiary{% endif %} h-100 position-relative">
          <div class="card-body p-3 text-start">
            <!-- título: nome do medium_de_linha (se existir) -->
            <div class="fw-semibold text-dark" style="font-size: 0.95rem;">
              <span class="nome-medium-de-linha" data-medium-id="{{ f.medium_de_linha.id|default:'' }}">
                {{ f.medium_de_linha.nome|default:"—" }}
              </span>
            </div>

            <!-- meta: pessoa atribuída OU '-' (nunca botão assumir/desistir nem 'Vago') -->
            <div class="text-muted" style="font-size:0.85rem;">
              {% if f.pessoa %}
                <span class="nome-pessoa" data-pessoa-id="{{ f.pessoa.id }}">{{ f.pessoa.nome }}</span>
              {% else %}
                <span class="nome-pessoa">—</span>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
</section>

<hr id="sep-2" class="my-4" style="border-color:{% if tema == 'exu' %}#660000{% else %}#ccc{% endif %};">

<!-- BLOCO ORGANIZAÇÃO -->
<section class="mb-5">
  <h4 id="title-organizacao" class="mb-3"
      style="font-size: 1.3rem; font-weight: 600;
             color:{% if tema == 'exu' %}#b00000{% else %}#2e2e2e{% endif %};">
    Organização
  </h4>

  <div id="organizacao-container" class="row g-3">
    {% for f in organizacao %}
      <div id="card-{{ f.chave }}" 
           data-funcao="{{ f.chave }}" 
           data-pessoa="{{ f.pessoa.id|default:'' }}" 
           class="col-6 col-md-4 col-lg-3">

        <div class="card border-0 shadow-sm 
             {% if tema == 'exu' %}bg-light{% else %}bg-body-tertiary{% endif %} 
             h-100 position-relative">

          {% if f.status|lower == 'vaga' %}
            <span class="badge bg-danger position-absolute"
                  style="right:10px; top:10px; font-size:0.7rem;">Vago</span>
          {% endif %}

          <div class="card-body p-3 text-start">
            <div class="fw-semibold text-dark" style="font-size:0.95rem;">
              {{ f.descricao|default:f.tipo }}
            </div>

            <div class="text-muted" style="font-size:0.85rem;">
              
              {% if f.status|lower == 'vaga' %}
                {% if pode_assumir %}
                  <button class="btn btn-sm btn-success btn-assumir"
                    data-funcao="{{ f.id }}"
                    data-chave="{{ f.chave }}"
                    data-gira-id="{{ gira.id }}"
                    style="font-size:0.8rem;">Assumir</button>
                {% else %}
                  <span>—</span>
                {% endif %}

              {% else %}
                <span class="nome-medium" data-medium-id="{{ f.pessoa.id|default:'' }}">
                  {{ f.pessoa.nome|default:"—" }}
                </span>

                {% if pode_assumir %}
                    <br>
                    <button class="btn btn-sm btn-danger btn-desistir"
                      data-funcao="{{ f.id }}"
                      data-chave="{{ f.chave }}"
                      data-gira-id="{{ gira.id }}"
                      style="font-size:0.8rem; margin-top:4px;">
                      Desistir
                    </button>
                {% endif %}
              {% endif %}

            </div>

          </div>
        </div>
      </div>
    {% endfor %}
  </div>
</section>

<hr id="sep-3" class="my-4" 
    style="border-color:{% if tema == 'exu' %}#660000{% else %}#ccc{% endif %};">


<!-- BLOCO LIMPEZA -->
<section class="mb-5">
  <h4 id="title-limpeza" class="mb-3"
      style="font-size: 1.3rem; font-weight: 600;
             color:{% if tema == 'exu' %}#b00000{% else %}#2e2e2e{% endif %};">
    Limpeza
  </h4>

  <div id="limpeza-container" class="row g-3">
    {% for f in limpeza %}
      <div id="card-{{ f.chave }}" 
           data-funcao="{{ f.chave }}" 
           data-pessoa="{{ f.pessoa.id|default:'' }}" 
           class="col-6 col-md-4 col-lg-3">

        <div class="card border-0 shadow-sm 
             {% if tema == 'exu' %}bg-light{% else %}bg-body-tertiary{% endif %} 
             h-100 position-relative">

          {% if f.status|lower == 'vaga' %}
            <span class="badge bg-danger position-absolute"
                  style="right:10px; top:10px; font-size:0.7rem;">Vago</span>
          {% endif %}

          <div class="card-body p-3 text-start">
            <div class="fw-semibold text-dark" style="font-size:0.95rem;">
              Limpeza
            </div>

            <div class="text-muted" style="font-size:0.85rem;">

              {% if f.status|lower == 'vaga' %}
                {% if pode_assumir %}
                  <button class="btn btn-sm btn-success btn-assumir"
                    data-funcao="{{ f.id }}"
                    data-chave="{{ f.chave }}"
                    data-gira-id="{{ gira.id }}"
                    style="font-size:0.8rem;">Assumir</button>
                {% else %}
                  <span>—</span>
                {% endif %}

              {% else %}
                <span class="nome-medium" data-medium-id="{{ f.pessoa.id|default:'' }}">
                  {{ f.pessoa.nome|default:"—" }}
                </span>

                {% if pode_assumir %}
                  <br>
                  <button class="btn btn-sm btn-danger btn-desistir"
                    data-funcao="{{ f.id }}"
                    data-chave="{{ f.chave }}"
                    data-gira-id="{{ gira.id }}"
                    style="font-size:0.8rem; margin-top:4px;">
                    Desistir
                  </button>
                {% endif %}
              {% endif %}

            </div>

          </div>
        </div>
      </div>
    {% endfor %}
  </div>
</section>

<p class="mt-4 text-center"
   style="font-size:0.95rem; color:{% if tema == 'exu' %}#d0d0d0{% else %}#444{% endif %};">
  Médiuns sem função definida na gira devem permanecer atentos, colaborar com os demais e apoiar a assistência quando necessário.
</p>
</div>

<!-- Toast -->
<div id="toast-funcao" class="toast-funcao"></div>

<!-- Loader centralizado e delicado -->
<div id="loading-overlay" aria-hidden="true">
  <div class="loader" role="status" aria-live="polite" aria-atomic="true">
    <span class="visually-hidden">Carregando...</span>
  </div>
</div>



<style>
.toast-funcao.show { visibility: visible; opacity: 1; }

/* Navbar com degradê (fallback inicial, será ajustado por JS ao mudar gira) */
{% if tema == 'exu' %}
.navbar { background: linear-gradient(to right, #000000, #4d0000, #990000); }
{% else %}
.navbar { background: linear-gradient(to right, #002147, #6e9cb9, #A4D2E8); }
{% endif %}
.navbar a, .navbar-brand, .navbar-nav .nav-link { color: #fff !important; }

/* fade transition para main-content */
#main-content.fade-out { opacity: 0.25; transition: opacity 220ms ease; pointer-events: none; }
#main-content.fade-in { opacity: 1; transition: opacity 220ms ease; }

/* loading overlay (small spinner, positioned near top-right of content) */
#loading-overlay {
  position: fixed;
  top: 10px;
  right: 18px;
  z-index: 1100;
  background: rgba(255,255,255,0.85);
  padding: 6px;
  border-radius: 6px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.12);
}
#loading-overlay .loading-spinner { display:flex; align-items:center; justify-content:center; }

/* body subtle visual while loading (only used if you want cursor wait) */
body.loading { cursor: wait; }

/* small responsiveness tweak so overlay doesn't cover arrows on small screens */
@media (max-width:576px) {
  #loading-overlay { right: 10px; top: 6px; }
}

  /* efeito de escurecimento leve enquanto carrega */
body.loading {
  cursor: wait;
  opacity: 0.7;
  transition: opacity 0.2s ease;
}

/* overlay centralizado */
#loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.15);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 2000;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.2s ease;
}

/* quando ativo */
body.loading #loading-overlay {
  opacity: 1;
}

/* spinner sutil */
.loader {
  width: 38px;
  height: 38px;
  border: 3px solid #ccc;
  border-top-color: #d33;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}
  /* Loader centralizado e discreto */
#loading-overlay {
  position: fixed;
  inset: 0;
  display: none;
  align-items: center;
  justify-content: center;
  background-color: rgba(0, 0, 0, 0.1);
  z-index: 9999;
}

.loading-spinner .spinner-border {
  color: #0072bb;
  width: 1.6rem;
  height: 1.6rem;
}

/* Fade geral */
.fade-out {
  opacity: 0;
  transition: opacity 0.2s ease;
}
.fade-in {
  opacity: 1;
  transition: opacity 0.2s ease;
}

/* Fade específico dos blocos */
.fade-block {
  opacity: 0.6;
  transition: opacity 0.3s ease;
}
.fade-block-out {
  opacity: 0;
  transition: opacity 0.25s ease;
}
.fade-block-in {
  opacity: 1;
  transition: opacity 0.25s ease;
}


</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const csrftoken = document.cookie.match('(^|;)\\s*csrftoken\\s*=\\s*([^;]+)')?.pop();
  const toast = document.getElementById('toast-funcao');
  const loadingOverlay = document.getElementById('loading-overlay');
  const mainContent = document.getElementById('main-content');
  const navbar = document.querySelector('.navbar');
  const sep1 = document.getElementById('sep-1');
  const sep2 = document.getElementById('sep-2');
  const sep3 = document.getElementById('sep-3');
  const titleCambones = document.getElementById('title-cambones');
  const titleOrg = document.getElementById('title-organizacao');
  const titleLimpeza = document.getElementById('title-limpeza');
  const prevBtn = document.getElementById('prevGira');
  const nextBtn = document.getElementById('nextGira');

  const mediumId = "{{ medium_logado.id|default:'' }}";
  const mediumNome = "{{ medium_logado.nome|default:user.nome|escapejs }}";

  // gira atual (inicial do template)
  let currentGiraId = parseInt("{{ gira.id }}");
  // timer do spinner
  let spinnerTimer = null;

  // util
  function showToast(msg, color='#198754') {
    if (!toast) return;
    toast.textContent = msg;
    toast.style.backgroundColor = color;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 1800);
  }

  // determina se uma gira (data ISO) permite edição: data >= hoje
  function giraPermiteEditar(isoDateTime) {
    if (!isoDateTime) return false;
    const d = new Date(isoDateTime);
    const today = new Date();
    // zera horas para comparar só a data
    today.setHours(0,0,0,0);
    d.setHours(0,0,0,0);
    return d.getTime() >= today.getTime();
  }

  // atualiza cor das setas conforme tema
  function aplicarCoresBotoes(isExu) {
    const corAtiva = isExu ? '#b00000' : '#0072bb';
    const corInativa = '#cccccc';
    if (!prevBtn || !nextBtn) return;
    prevBtn.style.color = prevBtn.disabled ? corInativa : corAtiva;
    nextBtn.style.color = nextBtn.disabled ? corInativa : corAtiva;
  }

  // render helpers (mantêm a mesma estrutura do template)
  function renderOwned(card) {
    if (!card) return;
    const meta = card.querySelector('.text-muted');
    if (!meta) return;
    // quando um médium assume via UI, o card.dataset.funcao contém a CHAVE
    const chave = card.dataset.funcao || '';
    meta.innerHTML = `
      <div class="d-flex align-items-center justify-content-start">
        <button class="btn btn-link text-dark fw-semibold btn-nome-medium p-0"
                data-medium-id="${mediumId}"
                data-funcao="${chave}"
                style="font-size:0.9rem;">
          ${mediumNome}
        </button>
        <button class="btn btn-link text-danger btn-desistir p-0 ms-2"
                data-chave="${chave}"
                data-gira-id="${currentGiraId}"
                title="Desistir"
                style="font-size:0.9rem;">
          <i class="bi bi-x-circle"></i>
        </button>
      </div>`;
    card.dataset.pessoa = mediumId;
  }

  function renderVacant(card, canEdit=true) {
    if (!card) return;
    const meta = card.querySelector('.text-muted');
    if (!meta) return;
    const chave = card.dataset.funcao || '';
    if (canEdit) {
      meta.innerHTML = `
        <button class="btn btn-sm btn-success btn-assumir"
                data-chave="${chave}"
                data-gira-id="${currentGiraId}"
                style="font-size:0.8rem;">
          Assumir
        </button>`;
    } else {
      meta.innerHTML = `<span>—</span>`;
    }
    delete card.dataset.pessoa;
  }

  // criarCard robusto e consistente com o template
  function criarCard(f, blocoName, isExu, canEdit) {
    // normaliza campos (aceita muitos formatos)
    const chave = f.chave ?? f.key ?? (f.id ? String(f.id) : `id${Math.random().toString(36).slice(2,8)}`);
    const funcaoId = f.id ?? f.funcao_id ?? f.pk ?? chave;
    const status = (f.status ?? f.st ?? '').toString();
    const descricao = f.descricao ?? f.tipo ?? f.nome ?? '';
    // pessoa atribuída — pode vir como pessoa_id / pessoa__nome / pessoa object
    const pessoaId = f.pessoa_id ?? (f.pessoa && f.pessoa.id) ?? '';
    const pessoaNome = f.pessoa_nome ?? (f.pessoa && f.pessoa.nome) ?? f.pessoa__nome ?? '';

    // medium_de_linha — prioridade para título do cambone
    let mediumLinhaNome = '';
    let mediumLinhaId = '';
    if (f.medium_de_linha) {
      if (typeof f.medium_de_linha === 'object') {
        mediumLinhaNome = f.medium_de_linha.nome ?? '';
        mediumLinhaId = f.medium_de_linha.id ?? '';
      } else mediumLinhaNome = String(f.medium_de_linha);
    }
    if (!mediumLinhaNome) mediumLinhaNome = f.medium_de_linha_nome ?? f.medium_de_linha__nome ?? '';

    const div = document.createElement('div');
    div.id = `card-${chave}`;
    div.dataset.funcao = chave; // chave como identificador consistente
    if (pessoaId) div.dataset.pessoa = pessoaId;
    if (mediumLinhaId) div.dataset.mediumDeLinhaId = mediumLinhaId;
    div.className = 'col-6 col-md-4 col-lg-3';

    const isVaga = (!pessoaId && !(status && status.toLowerCase() && !status.toLowerCase().includes('vaga') )) || (status && status.toLowerCase().includes('vaga'));

    // título conforme bloco
    let titulo = '—';
    if (blocoName === 'cambones') {
      if (mediumLinhaNome && mediumLinhaNome.trim() !== '') titulo = mediumLinhaNome;
      else if (descricao && descricao.trim() !== '') titulo = descricao;
      else titulo = '—';
    } else if (blocoName === 'limpeza') {
      titulo = 'Limpeza';
    } else {
      titulo = descricao || '—';
    }

    const bgClass = isExu ? 'bg-light' : 'bg-body-tertiary';

    // Montagem: cambones NÃO mostra botões nem badge "Vago"
    if (blocoName === 'cambones') {
      const pessoaDisplay = pessoaNome && pessoaNome.trim() !== '' ? pessoaNome : '—';
      div.innerHTML = `
        <div class="card border-0 shadow-sm ${bgClass} h-100 position-relative">
          <div class="card-body p-3 text-start">
            <div class="fw-semibold text-dark" style="font-size:0.95rem;">
              <button class="btn btn-link p-0 nome-medium-de-linha" data-medium-id="${mediumLinhaId}" style="font-size:0.95rem;">
                ${titulo}
              </button>
            </div>
            <div class="text-muted" style="font-size:0.85rem;">
              <span class="nome-pessoa" data-pessoa-id="${pessoaId}">${pessoaDisplay}</span>
            </div>
          </div>
        </div>`;
      return div;
    }

    // Para organizacao e limpeza: mantém badge Vago e botões conforme canEdit
    div.innerHTML = `
      <div class="card border-0 shadow-sm ${bgClass} h-100 position-relative">
        ${isVaga ? `<span class="badge bg-danger position-absolute" style="right:10px; top:10px; font-size:0.7rem;">Vago</span>` : ''}
        <div class="card-body p-3 text-start">
          <div class="fw-semibold text-dark" style="font-size:0.95rem;">${titulo}</div>
          <div class="text-muted" style="font-size:0.85rem;">
            ${isVaga
              ? (canEdit ? `<button class="btn btn-sm btn-success btn-assumir" data-chave="${chave}" data-gira-id="${currentGiraId}" style="font-size:0.8rem;">Assumir</button>` : `<span>—</span>`)
              : `<button class="btn btn-link text-dark fw-semibold btn-nome-medium p-0" data-medium-id="${pessoaId}" data-chave="${chave}" data-gira-id="${currentGiraId}" style="font-size:0.9rem;">${pessoaNome || '—'}</button>`
            }
          </div>
        </div>
      </div>`;
    return div;
  }

  // atualiza container com fade e logs
  function atualizarContainer(container, items, blocoName, isExu, canEdit) {
    if (!container) return;
    console.debug('[atualizarContainer] bloco:', blocoName, 'items.length=', (items||[]).length);
    container.classList.add('fade-block-out');
    setTimeout(() => {
      container.innerHTML = '';
      (items || []).forEach(f => container.appendChild(criarCard(f, blocoName, isExu, canEdit)));
      container.classList.remove('fade-block-out');
      container.classList.add('fade-block-in');
      setTimeout(() => container.classList.remove('fade-block-in'), 250);
    }, 120);
  }

  // carregarGira completo e robusto
  window.carregarGira = async function (giraId, apenasTema=false) {
    console.info('[carregarGira] start', { giraId, apenasTema });
    try {
      // visual
      mainContent.classList.add('fade-out');
      clearTimeout(spinnerTimer);
      spinnerTimer = setTimeout(() => document.body.classList.add('loading'), 200);

      const resp = await fetch(`/funcoes_dev/data/${giraId}/`);
      const dados = await resp.json();
      console.debug('[carregarGira] dados recebidos:', dados);

      // atualiza currentGiraId (importante)
      currentGiraId = Number(dados.gira?.id ?? giraId);

      // atualiza header (data e linha)
      const dataEl = document.querySelector('#gira-data');
      const linhaEl = document.querySelector('#gira-linha');
      if (dataEl && dados.gira && dados.gira.data_hora) {
        dataEl.innerText = new Date(dados.gira.data_hora).toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' });
      }
      if (linhaEl && dados.gira && dados.gira.linha) {
        linhaEl.innerText = dados.gira.linha;
      }

      // aplica tema imediatamente (header + separadores + títulos)
      const novaLinha = dados.gira?.linha ?? (document.querySelector('#gira-linha')?.innerText || '');
      const isExu = /exu/i.test(novaLinha || '');
      if (navbar) navbar.style.background = isExu
        ? 'linear-gradient(to right, #000000, #4d0000, #990000)'
        : 'linear-gradient(to right, #002147, #6e9cb9, #A4D2E8)';

      const corAtiva = isExu ? '#b00000' : '#0072bb';
      const corSec = isExu ? '#660000' : '#cccccc';
      if (dataEl) dataEl.style.color = isExu ? '#ff4d4d' : '#0072bb';
      if (linhaEl) linhaEl.style.color = isExu ? '#c00000' : '#222222';
      if (sep1) sep1.style.borderColor = corSec;
      if (sep2) sep2.style.borderColor = corSec;
      if (sep3) sep3.style.borderColor = corSec;
      if (titleCambones) titleCambones.style.color = corAtiva;
      if (titleOrg) titleOrg.style.color = corAtiva;
      if (titleLimpeza) titleLimpeza.style.color = corAtiva;

      aplicarCoresBotoes(isExu);

      if (apenasTema) {
        console.info('[carregarGira] apenasTema true — atualizou tema/datas apenas');
        return;
      }

      // containers
      const cambonesContainer = document.querySelector('#cambones-container');
      const orgContainer = document.querySelector('#organizacao-container');
      const limpezaContainer = document.querySelector('#limpeza-container');

      // determine canEdit para esta gira (data >= hoje)
      const podeEditarEstaGira = giraPermiteEditar(dados.gira?.data_hora);

      // agrupar funcoes / aceitar vários formatos
      let grouped = { cambones: [], organizacao: [], limpeza: [] };
      if (Array.isArray(dados.cambones) || Array.isArray(dados.organizacao) || Array.isArray(dados.limpeza)) {
        grouped.cambones = Array.isArray(dados.cambones) ? dados.cambones : [];
        grouped.organizacao = Array.isArray(dados.organizacao) ? dados.organizacao : [];
        grouped.limpeza = Array.isArray(dados.limpeza) ? dados.limpeza : [];
      } else if (Array.isArray(dados.funcoes)) {
        function descricaoIncluiLimpeza(f) {
          const text = ((f.descricao || f.tipo || f.nome || '') + '').toLowerCase();
          return text.includes('limpeza') || text.includes('limpo') || text.includes('faxina');
        }
        dados.funcoes.forEach(f => {
          const tipo = (f.tipo || f.descricao || '').toString().toLowerCase();
          const grupo = (f.grupo || '').toString().toLowerCase();
          if (grupo.includes('cambon') || tipo.includes('cambon')) grouped.cambones.push(f);
          else if (tipo.includes('limpeza') || descricaoIncluiLimpeza(f)) grouped.limpeza.push(f);
          else grouped.organizacao.push(f);
        });
      } else {
        console.warn('[carregarGira] formato inesperado — limpando containers', dados);
        if (cambonesContainer) cambonesContainer.innerHTML = '';
        if (orgContainer) orgContainer.innerHTML = '';
        if (limpezaContainer) limpezaContainer.innerHTML = '';
        return;
      }

      // atualiza containers (passa canEdit)
      atualizarContainer(cambonesContainer, grouped.cambones, 'cambones', isExu, podeEditarEstaGira);
      atualizarContainer(orgContainer, grouped.organizacao, 'organizacao', isExu, podeEditarEstaGira);
      atualizarContainer(limpezaContainer, grouped.limpeza, 'limpeza', isExu, podeEditarEstaGira);

      console.info('[carregarGira] cards atualizados para gira', currentGiraId, 'podeEditar=', podeEditarEstaGira);
    } catch (err) {
      console.error('[carregarGira] erro:', err);
      showToast('Erro ao carregar gira', '#dc3545');
    } finally {
      clearTimeout(spinnerTimer);
      document.body.classList.remove('loading');
      requestAnimationFrame(() => {
        mainContent.classList.remove('fade-out');
        mainContent.classList.add('fade-in');
        setTimeout(() => mainContent.classList.remove('fade-in'), 260);
      });
      console.info('[carregarGira] fim (finally)');
    }
  };

  // =========================
  // Eventos ASSUMIR / DESISTIR / CLIQUE NOME (delegação)
  // =========================
  document.addEventListener('click', async (e) => {
    // ASSUMIR (botão)
    const btnAssumir = e.target.closest('.btn-assumir');
    if (btnAssumir) {
      const chave = btnAssumir.dataset.chave;
      const giraIdAttr = btnAssumir.dataset.giraId ?? currentGiraId;
      const card = document.querySelector(`[data-funcao="${chave}"]`);
      // visual imediato
      renderOwned(card);
      showToast('Assumindo função...', '#0d6efd');

      try {
        const res = await fetch("{% url 'gira:assumir_funcao' %}", {
          method: 'POST',
          headers: {'X-CSRFToken': csrftoken, 'Content-Type':'application/x-www-form-urlencoded'},
          body: new URLSearchParams({ funcao_chave: chave, gira_id: giraIdAttr })
        });
        const d = await res.json();
        if (!d || d.status !== 'ok') {
          renderVacant(card, true);
          showToast(d?.mensagem || 'Erro ao assumir', '#dc3545');
        } else {
          showToast(d.mensagem || 'Função assumida', '#198754');
        }
      } catch (err) {
        console.error('Assumir erro:', err);
        renderVacant(card, true);
        showToast('Erro de rede ao assumir', '#dc3545');
      }
      return;
    }

    // DESISTIR (botão)
    const btnDesistir = e.target.closest('.btn-desistir');
    if (btnDesistir) {
      const chave = btnDesistir.dataset.chave ?? btnDesistir.dataset.funcao;
      const giraIdAttr = btnDesistir.dataset.giraId ?? currentGiraId;
      const card = document.querySelector(`[data-funcao="${chave}"]`);
      // visual imediato
      renderVacant(card, true);
      showToast('Desistindo da função...', '#ffc107');

      try {
        const res = await fetch("{% url 'gira:desistir_funcao' %}", {
          method: 'POST',
          headers: {'X-CSRFToken': csrftoken, 'Content-Type':'application/x-www-form-urlencoded'},
          body: new URLSearchParams({ funcao_chave: chave, gira_id: giraIdAttr })
        });
        const d = await res.json();
        if (!d || d.status !== 'ok') {
          renderOwned(card);
          showToast(d?.mensagem || 'Erro ao desistir', '#dc3545');
        } else {
          showToast(d.mensagem || 'Função liberada', '#0dcaf0');
        }
      } catch (err) {
        console.error('Desistir erro:', err);
        renderOwned(card);
        showToast('Erro de rede ao desistir', '#dc3545');
      }
      return;
    }

    // CLIQUE NO NOME (botão .btn-nome-medium) — se for o próprio, é ação de desistir rápida
    const btnNome = e.target.closest('.btn-nome-medium, .nome-medium-de-linha, .nome-pessoa');
    if (btnNome) {
      const chave = btnNome.dataset.chave ?? btnNome.closest('[data-funcao]')?.dataset.funcao;
      const pessoaMediumId = btnNome.dataset.mediumId ?? btnNome.dataset.pessoaId;
      // se clicou no próprio médium logado → tenta desistir
      if (String(pessoaMediumId) === String(mediumId)) {
        const card = document.querySelector(`[data-funcao="${chave}"]`);
        if (!card) { showToast('Não encontrado', '#dc3545'); return; }
        // enviar desistir
        renderVacant(card, true);
        showToast('Desistindo...', '#ffc107');
        try {
          const res = await fetch("{% url 'gira:desistir_funcao' %}", {
            method: 'POST',
            headers: {'X-CSRFToken': csrftoken, 'Content-Type':'application/x-www-form-urlencoded'},
            body: new URLSearchParams({ funcao_chave: chave, gira_id: currentGiraId })
          });
          const d = await res.json();
          if (!d || d.status !== 'ok') {
            renderOwned(card);
            showToast(d?.mensagem || 'Erro ao desistir', '#dc3545');
          } else {
            showToast(d.mensagem || 'Função liberada', '#0dcaf0');
          }
        } catch (err) {
          console.error('Desistir via nome erro:', err);
          renderOwned(card);
          showToast('Erro de rede ao desistir', '#dc3545');
        }
      } else {
        // clicou em outro nome — apenas feedback
        showToast('Função ocupada', '#6c757d');
      }
    }
  });

  // CARROSSEL
  const giras = {{ giras_json|safe }};
  let index = giras.findIndex(g => g.id === parseInt("{{ gira.id }}"));

  function atualizarBotoes() {
    if (!prevBtn || !nextBtn) return;
    prevBtn.disabled = (index <= 0);
    nextBtn.disabled = (index >= giras.length - 1);
    const linhaText = document.querySelector('#gira-linha')?.innerText ?? '';
    const isExuNow = /exu/i.test(linhaText || '');
    aplicarCoresBotoes(isExuNow);
  }

  function navegar(offset) {
    const novo = index + offset;
    if (novo >= 0 && novo < giras.length) {
      index = novo;
      const proxima = giras[index];

      // atualiza header IMEDIATAMENTE
      const dataEl = document.querySelector('#gira-data');
      const linhaEl = document.querySelector('#gira-linha');
      if (dataEl && proxima.data_hora) dataEl.innerText = new Date(proxima.data_hora).toLocaleString('pt-BR', { dateStyle:'short', timeStyle:'short' });
      if (linhaEl && proxima.linha) linhaEl.innerText = proxima.linha;

      // atualiza tema IMEDIATAMENTE
      const isExu = /exu/i.test(proxima.linha || '');
      if (navbar) navbar.style.background = isExu
        ? 'linear-gradient(to right,#000000,#4d0000,#990000)'
        : 'linear-gradient(to right,#002147,#6e9cb9,#A4D2E8)';

      const corAtiva = isExu ? '#b00000' : '#0072bb';
      const corSec = isExu ? '#660000' : '#cccccc';
      if (dataEl) dataEl.style.color = isExu ? '#ff4d4d' : '#0072bb';
      if (linhaEl) linhaEl.style.color = isExu ? '#c00000' : '#222222';
      if (sep1) sep1.style.borderColor = corSec;
      if (sep2) sep2.style.borderColor = corSec;
      if (sep3) sep3.style.borderColor = corSec;
      if (titleCambones) titleCambones.style.color = corAtiva;
      if (titleOrg) titleOrg.style.color = corAtiva;
      if (titleLimpeza) titleLimpeza.style.color = corAtiva;

      aplicarCoresBotoes(isExu);
      atualizarBotoes();

      // carrega os dados completos em background
      window.carregarGira(proxima.id);
    }
  }

  if (prevBtn && nextBtn) {
    prevBtn.addEventListener('click', () => navegar(-1));
    nextBtn.addEventListener('click', () => navegar(1));
  }

  // swipe mobile
  let touchStartX = 0;
  document.addEventListener('touchstart', e => touchStartX = e.changedTouches[0].screenX);
  document.addEventListener('touchend', e => {
    const touchEndX = e.changedTouches[0].screenX;
    if (Math.abs(touchEndX - touchStartX) > 60) {
      navegar(touchEndX - touchStartX > 0 ? -1 : 1);
    }
  });

  // inicialização
  atualizarBotoes();
  console.info('[script] inicializado');
});
</script>


{% endblock %}

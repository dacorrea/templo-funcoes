{% extends 'gira/base.html' %}

{% block content %}
<div class="container my-0">

{% if gira %}
  <div class="text-start position-relative" style="width:100%; margin-top: 0.5rem;">

    <!-- Linha de setas bem próxima à navbar -->
    <div class="d-flex justify-content-between align-items-center mb-0" style="margin-top:0.3rem;">
      <button id="prevGira" class="btn btn-link p-0" title="Gira anterior"
              style="color:#bbb; background:transparent; border:none;">
        <i class="bi bi-chevron-left" style="font-size:1.3rem;"></i>
      </button>

      <button id="nextGira" class="btn btn-link p-0" title="Próxima gira"
              style="color:#bbb; background:transparent; border:none;">
        <i class="bi bi-chevron-right" style="font-size:1.3rem;"></i>
      </button>
    </div>

    <!-- Data e linha -->
    <p id="gira-data" class="mb-1 mt-1"
       style="font-size: 0.9rem; font-weight: 500;
              color: {% if tema == 'exu' %}#ff4d4d{% else %}#0072bb{% endif %};">
      {{ gira.data_hora|date:"d/m/Y H:i" }}
    </p>

    <h2 id="gira-linha" class="mb-1"
        style="font-size: 1.5rem; font-weight: 700;
               color: {% if tema == 'exu' %}#c00000{% else %}#222222{% endif %};">
      {{ gira.linha }}
    </h2>

    <!-- Frase fixa -->
    <p class="mb-0"
       style="font-size: 0.9rem;
              color: {% if tema == 'exu' %}#d0d0d0{% else %}#444444{% endif %};">
      Escolha ou visualize as funções assumidas para esta gira.<br>
      Cambones e responsáveis de cada área estão listados abaixo.
    </p>

  </div>
{% else %}
  <div class="alert alert-warning">Nenhuma gira encontrada.</div>
{% endif %}

<hr class="my-4"
    style="border-color: {% if tema == 'exu' %}#660000{% else %}#cccccc{% endif %};">

<!-- BLOCO CAMBONES -->
<section class="mb-5">
  <h4 class="mb-3"
      style="font-size: 1.3rem; font-weight: 600;
             color: {% if tema == 'exu' %}#b00000{% else %}#2e2e2e{% endif %};">
    Cambones
  </h4>

  <div id="cambones-container" class="row g-3">
    {% for f in cambones %}
      <div id="card-{{ f.chave }}" data-funcao="{{ f.chave }}" data-pessoa="{{ f.pessoa.id|default:'' }}" class="col-6 col-md-4 col-lg-3">
        <div class="card border-0 shadow-sm {% if tema == 'exu' %}bg-light{% else %}bg-body-tertiary{% endif %} h-100 position-relative">
          <div class="card-body p-3 text-start">
            <div class="fw-semibold text-dark" style="font-size: 0.95rem;">
              <span class="nome-medium" data-medium-id="{{ f.medium_de_linha.id|default:'' }}">{{ f.medium_de_linha.nome|default:"—" }}</span>
            </div>
            <div class="text-muted" style="font-size:0.85rem;">
              {% if f.status|lower == 'vaga' %}
                <button class="btn btn-sm btn-success btn-assumir" data-funcao="{{ f.id }}" style="font-size:0.8rem;">Assumir</button>
              {% else %}
                <span class="nome-medium" data-medium-id="{{ f.pessoa.id|default:'' }}">{{ f.pessoa.nome|default:"—" }}</span>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
</section>

<hr class="my-4" style="border-color:{% if tema == 'exu' %}#660000{% else %}#ccc{% endif %};">

<!-- BLOCO ORGANIZAÇÃO -->
<section class="mb-5">
  <h4 class="mb-3"
      style="font-size: 1.3rem; font-weight: 600;
             color:{% if tema == 'exu' %}#b00000{% else %}#2e2e2e{% endif %};">
    Organização
  </h4>

  <div id="organizacao-container" class="row g-3">
    {% for f in organizacao %}
      <div id="card-{{ f.chave }}" data-funcao="{{ f.chave }}" data-pessoa="{{ f.pessoa.id|default:'' }}" class="col-6 col-md-4 col-lg-3">
        <div class="card border-0 shadow-sm {% if tema == 'exu' %}bg-light{% else %}bg-body-tertiary{% endif %} h-100 position-relative">
          {% if f.status|lower == 'vaga' %}
            <span class="badge bg-danger position-absolute" style="right:10px; top:10px; font-size:0.7rem;">Vago</span>
          {% endif %}
          <div class="card-body p-3 text-start">
            <div class="fw-semibold text-dark" style="font-size:0.95rem;">{{ f.descricao|default:f.tipo }}</div>
            <div class="text-muted" style="font-size:0.85rem;">
              {% if f.status|lower == 'vaga' %}
                <button class="btn btn-sm btn-success btn-assumir" data-funcao="{{ f.id }}" style="font-size:0.8rem;">Assumir</button>
              {% else %}
                <span class="nome-medium" data-medium-id="{{ f.pessoa.id|default:'' }}">{{ f.pessoa.nome|default:"—" }}</span>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
</section>

<hr class="my-4" style="border-color:{% if tema == 'exu' %}#660000{% else %}#ccc{% endif %};">

<!-- BLOCO LIMPEZA -->
<section class="mb-5">
  <h4 class="mb-3"
      style="font-size: 1.3rem; font-weight: 600;
             color:{% if tema == 'exu' %}#b00000{% else %}#2e2e2e{% endif %};">
    Limpeza
  </h4>

  <div id="limpeza-container" class="row g-3">
    {% for f in limpeza %}
      <div id="card-{{ f.chave }}" data-funcao="{{ f.chave }}" data-pessoa="{{ f.pessoa.id|default:'' }}" class="col-6 col-md-4 col-lg-3">
        <div class="card border-0 shadow-sm {% if tema == 'exu' %}bg-light{% else %}bg-body-tertiary{% endif %} h-100 position-relative">
          {% if f.status|lower == 'vaga' %}
            <span class="badge bg-danger position-absolute" style="right:10px; top:10px; font-size:0.7rem;">Vago</span>
          {% endif %}
          <div class="card-body p-3 text-start">
            <div class="fw-semibold text-dark" style="font-size:0.95rem;">Limpeza</div>
            <div class="text-muted" style="font-size:0.85rem;">
              {% if f.status|lower == 'vaga' %}
                <button class="btn btn-sm btn-success btn-assumir" data-funcao="{{ f.id }}" style="font-size:0.8rem;">Assumir</button>
              {% else %}
                <span class="nome-medium" data-medium-id="{{ f.pessoa.id|default:'' }}">{{ f.pessoa.nome|default:"—" }}</span>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
</section>

<p class="mt-4 text-center"
   style="font-size:0.95rem; color:{% if tema == 'exu' %}#d0d0d0{% else %}#444{% endif %};">
  Médiuns sem função definida devem colaborar com os demais.
</p>
</div>

<div id="toast-funcao" class="toast-funcao"></div>

<style>
.toast-funcao.show { visibility: visible; opacity: 1; }

/* Navbar com degradê */
{% if tema == 'exu' %}
.navbar { background: linear-gradient(to right, #000000, #4d0000, #990000); }
{% else %}
.navbar { background: linear-gradient(to right, #002147, #6e9cb9, #A4D2E8); }
{% endif %}
.navbar a, .navbar-brand, .navbar-nav .nav-link { color: #fff !important; }
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const csrftoken = document.cookie.match('(^|;)\\s*csrftoken\\s*=\\s*([^;]+)')?.pop();
  const toast = document.getElementById('toast-funcao');
  const mediumId = "{{ medium_logado.id|default:'' }}";
  const mediumNome = "{{ medium_logado.nome|default:user.nome|escapejs }}";

  function showToast(msg, color='#198754') {
    toast.textContent = msg;
    toast.style.backgroundColor = color;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 1800);
  }

  function renderOwned(card) {
    const meta = card.querySelector('.text-muted');
    if (!meta) return;
    meta.innerHTML = `
      <div class="d-flex align-items-center justify-content-start">
        <span class="nome-medium me-1" data-medium-id="${mediumId}" style="font-weight:500;">${mediumNome}</span>
        <button class="btn btn-link text-danger btn-desistir p-0 ms-1"
                data-funcao="${card.dataset.funcao}"
                title="Desistir"
                style="font-size:0.9rem; line-height:1;">
          <i class="bi bi-x-circle"></i>
        </button>
      </div>`;
    card.dataset.pessoa = mediumId;
  }

  function renderVacant(card) {
    const meta = card.querySelector('.text-muted');
    if (!meta) return;
    meta.innerHTML = `<button class="btn btn-sm btn-success btn-assumir" data-funcao="${card.dataset.funcao}" style="font-size:0.8rem;">Assumir</button>`;
    card.dataset.pessoa = '';
  }

  // =========================
  // AJAX para carregar gira
  // =========================
  // substituir a implementação existente por esta
window.carregarGira = async function (giraId) {
  try {
    const resp = await fetch(`/funcoes_dev/data/${giraId}/`);
    const dados = await resp.json();

    // atualiza data e linha (só se existirem os elementos)
    const dataEl = document.querySelector('#gira-data');
    const linhaEl = document.querySelector('#gira-linha');
    if (dataEl && dados.gira && dados.gira.data_hora) {
      dataEl.innerText = new Date(dados.gira.data_hora).toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' });
    }
    if (linhaEl && dados.gira && dados.gira.linha) {
      linhaEl.innerText = dados.gira.linha;
    }

    // garante containers existirem
    const cambonesContainer = document.querySelector('#cambones-container');
    const orgContainer = document.querySelector('#organizacao-container');
    const limpezaContainer = document.querySelector('#limpeza-container');

    // função utilitária para criar um card DOM compatível com seu template
    function criarCard(f, blocoName) {
      // tenta extrair chave, id, status e pessoa a partir de possíveis campos
      const chave = f.chave ?? f.key ?? f.id ?? `id${Math.random().toString(36).slice(2,8)}`;
      const funcaoId = f.id ?? f.funcao_id ?? f.pk ?? chave;
      const status = (f.status || f.st || '').toString();
      const descricao = f.descricao || f.tipo || '';
      // pessoa pode vir como objeto ou apenas id (values() usualmente retorna pessoa_id)
      const pessoaId = (f.pessoa && f.pessoa.id) ? f.pessoa.id : (f.pessoa_id ?? f.pessoa ?? '');
      const pessoaNome = (f.pessoa && f.pessoa.nome) ? f.pessoa.nome : (f.pessoa_nome ?? f.pessoa_nome_display ?? '');

      const div = document.createElement('div');
      div.id = `card-${chave}`;
      div.dataset.funcao = chave;
      if (pessoaId) div.dataset.pessoa = pessoaId;
      div.className = 'col-6 col-md-4 col-lg-3';

      // marca "Vago" se status indicar vaga
      const isVaga = status.toLowerCase().includes('vaga') || status.toLowerCase().includes('open') || status === '';

      div.innerHTML = `
        <div class="card border-0 shadow-sm h-100 position-relative">
          ${isVaga ? `<span class="badge bg-danger position-absolute" style="right:10px; top:10px; font-size:0.7rem;">Vago</span>` : ''}
          <div class="card-body p-3 text-start">
            <div class="fw-semibold text-dark" style="font-size:0.95rem;">
              ${descricao || (blocoName === 'limpeza' ? 'Limpeza' : '—')}
            </div>
            <div class="text-muted" style="font-size:0.85rem;">
              ${isVaga
                ? `<button class="btn btn-sm btn-success btn-assumir" data-funcao="${funcaoId}" style="font-size:0.8rem;">Assumir</button>`
                : `<span class="nome-medium" data-medium-id="${pessoaId}">${pessoaNome || '—'}</span>`}
            </div>
          </div>
        </div>`;

      return div;
    }

    // se o backend já devolve os blocos separados, usa-os; senão agrupa a lista plana
    let grouped = { cambones: [], organizacao: [], limpeza: [] };

    if (Array.isArray(dados.cambones) || Array.isArray(dados.organizacao) || Array.isArray(dados.limpeza)) {
      // usa o que chegou (faz fallback para lista vazia)
      grouped.cambones = Array.isArray(dados.cambones) ? dados.cambones : [];
      grouped.organizacao = Array.isArray(dados.organizacao) ? dados.organizacao : [];
      grouped.limpeza = Array.isArray(dados.limpeza) ? dados.limpeza : [];
    } else if (Array.isArray(dados.funcoes)) {
      // agrupa usando heurísticas: campo 'grupo', 'tipo' ou palavras-chave
      dados.funcoes.forEach(f => {
        const tipo = (f.tipo || f.descricao || '').toString().toLowerCase();
        const grupo = (f.grupo || '').toString().toLowerCase();

        // regras simples (ajuste as palavras-chave conforme seus dados reais)
        if (grupo.includes('cambon') || tipo.includes('cambon') || tipo.includes('cambone') || tipo.includes('cambones')) {
          grouped.cambones.push(f);
        } else if (tipo.includes('limpeza') || descricaoIncludesLimpeza(f)) {
          grouped.limpeza.push(f);
        } else {
          // tudo que não for limpeza ou cambones vai para organização
          grouped.organizacao.push(f);
        }
      });

      // helper para detectar limpeza em outros campos
      function descricaoIncludesLimpeza(f) {
        const text = ((f.descricao || f.tipo || f.nome || '') + '').toLowerCase();
        return text.includes('limpeza') || text.includes('limpo') || text.includes('faxina');
      }
    } else {
      // formato inesperado: limpa containers e termina
      if (cambonesContainer) cambonesContainer.innerHTML = '';
      if (orgContainer) orgContainer.innerHTML = '';
      if (limpezaContainer) limpezaContainer.innerHTML = '';
      console.warn('carregarGira: formato de dados inesperado', dados);
      return;
    }

    // substitui conteúdo dos containers (apaga e reconstrói)
    if (cambonesContainer) {
      cambonesContainer.innerHTML = '';
      grouped.cambones.forEach(f => cambonesContainer.appendChild(criarCard(f, 'cambones')));
    }
    if (orgContainer) {
      orgContainer.innerHTML = '';
      grouped.organizacao.forEach(f => orgContainer.appendChild(criarCard(f, 'organizacao')));
    }
    if (limpezaContainer) {
      limpezaContainer.innerHTML = '';
      grouped.limpeza.forEach(f => limpezaContainer.appendChild(criarCard(f, 'limpeza')));
    }

    // OBS: seus listeners de assumir/desistir usam delegação no document, então
    // os botões recém-criados já funcionarão sem re-bind.
  } catch (err) {
    console.error('Erro ao carregar gira:', err);
  }
}


  // =========================
  // Eventos ASSUMIR / DESISTIR
  // =========================
  document.addEventListener('click', e => {
    const btnAssumir = e.target.closest('.btn-assumir');
    const btnDesistir = e.target.closest('.btn-desistir');

    if (btnAssumir) {
      const funcaoId = btnAssumir.dataset.funcao;
      const card = document.getElementById(`card-${funcaoId}`);
      renderOwned(card);
      showToast('Assumindo função...', '#0d6efd');
      fetch("{% url 'gira:assumir_funcao' %}", {
        method: 'POST',
        headers: {'X-CSRFToken': csrftoken, 'Content-Type':'application/x-www-form-urlencoded'},
        body: new URLSearchParams({ funcao_chave: funcaoId })
      }).then(r => r.json())
        .then(d => {
          if (d.status !== 'ok') renderVacant(card);
          showToast(d.mensagem || (d.status==='ok' ? 'Função assumida' : 'Erro ao assumir'), d.status==='ok' ? '#198754' : '#dc3545');
        })
        .catch(() => { renderVacant(card); showToast('Erro de rede ao assumir', '#dc3545'); });
    }

    if (btnDesistir) {
      const funcaoId = btnDesistir.dataset.funcao;
      const card = document.getElementById(`card-${funcaoId}`);
      renderVacant(card);
      showToast('Desistindo da função...', '#ffc107');
      fetch("{% url 'gira:desistir_funcao' %}", {
        method: 'POST',
        headers: {'X-CSRFToken': csrftoken, 'Content-Type':'application/x-www-form-urlencoded'},
        body: new URLSearchParams({ funcao_id: funcaoId })
      }).then(r => r.json())
        .then(d => {
          if (d.status !== 'ok') renderOwned(card);
          showToast(d.mensagem || (d.status==='ok' ? 'Função liberada' : 'Erro ao desistir'), d.status==='ok' ? '#0dcaf0' : '#dc3545');
        })
        .catch(() => { renderOwned(card); showToast('Erro de rede ao desistir', '#dc3545'); });
    }
  });

  // =========================
  // CARROSSEL DE GIRAS
  // =========================
  const prevBtn = document.getElementById('prevGira');
  const nextBtn = document.getElementById('nextGira');
  const giras = {{ giras_json|safe }};
  let index = giras.findIndex(g => g.id === parseInt("{{ gira.id }}"));

  const corAtiva = "{{ tema }}" === 'exu' ? '#b00000' : '#0072bb';
  const corInativa = '#cccccc';

  function atualizarBotoes() {
    prevBtn.disabled = (index <= 0);
    nextBtn.disabled = (index >= giras.length - 1);
    prevBtn.style.color = prevBtn.disabled ? corInativa : corAtiva;
    nextBtn.style.color = nextBtn.disabled ? corInativa : corAtiva;
  }

  function navegar(offset) {
    const novo = index + offset;
    if (novo >= 0 && novo < giras.length) {
      index = novo;
      window.carregarGira(giras[index].id);
      atualizarBotoes();
    }
  }

  if (prevBtn && nextBtn) {
    prevBtn.addEventListener('click', () => navegar(-1));
    nextBtn.addEventListener('click', () => navegar(1));
    atualizarBotoes();
  }

  // Swipe mobile
  let touchStartX = 0;
  document.addEventListener('touchstart', e => touchStartX = e.changedTouches[0].screenX);
  document.addEventListener('touchend', e => {
    const touchEndX = e.changedTouches[0].screenX;
    if (Math.abs(touchEndX - touchStartX) > 60) {
      navegar(touchEndX - touchStartX > 0 ? -1 : 1);
    }
  });

});
</script>

{% endblock %}

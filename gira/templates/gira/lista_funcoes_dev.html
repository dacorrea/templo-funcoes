{% extends 'gira/base.html' %}

{% block content %}
<div class="container my-4">

 {% if gira %}
  <div class="mb-4 position-relative">
    
    <!-- Contêiner principal -->
    <div class="d-flex justify-content-between align-items-center position-relative mb-2">
      
      <!-- Seta esquerda -->
      <button id="prevGira"
              class="btn btn-link p-0 position-absolute"
              style="left: 0; top: 50%; transform: translateY(-50%); color: #ccc;"
              title="Gira anterior">
        <i class="bi bi-chevron-left" style="font-size:1.6rem;"></i>
      </button>

      <!-- Bloco central (data + linha + frase) -->
      <div class="mx-auto text-start" style="max-width: 90%;">
        <p class="mb-1"
           style="font-size: 0.95rem; font-weight: 500;
                  color: {% if tema == 'exu' %}#ff4d4d{% else %}#0072bb{% endif %};">
          {{ gira.data_hora|date:"d/m/Y H:i" }}
        </p>

        <h2 class="mb-2"
            style="font-size: 1.6rem; font-weight: 700;
                   color: {% if tema == 'exu' %}#c00000{% else %}#222222{% endif %};">
          {{ gira.linha }}
        </h2>

        <p class="mb-0"
           style="font-size: 0.95rem;
                  color: {% if tema == 'exu' %}#d0d0d0{% else %}#444444{% endif %};">
          Escolha ou visualize as funções assumidas para esta gira.<br>
          Cambones e responsáveis de cada área estão listados abaixo.
        </p>
      </div>

      <!-- Seta direita -->
      <button id="nextGira"
              class="btn btn-link p-0 position-absolute"
              style="right: 0; top: 50%; transform: translateY(-50%); color: #ccc;"
              title="Próxima gira">
        <i class="bi bi-chevron-right" style="font-size:1.6rem;"></i>
      </button>
    </div>

  </div>
{% else %}
  <div class="alert alert-warning">Nenhuma gira encontrada.</div>
{% endif %}



  <hr class="my-4"
      style="border-color: {% if tema == 'exu' %}#660000{% else %}#cccccc{% endif %};">

  <!-- BLOCO CAMBONES -->
  <section class="mb-5">
    <h4 class="mb-3"
        style="font-size: 1.3rem; font-weight: 600;
               color: {% if tema == 'exu' %}#b00000{% else %}#2e2e2e{% endif %};">
      Cambones
    </h4>

    {% if cambones %}
      <div class="row g-3">
        {% for f in cambones %}
          <div id="card-{{ f.chave }}" data-funcao="{{ f.chave }}" data-pessoa="{{ f.pessoa.id|default:'' }}" class="col-6 col-md-4 col-lg-3">
            <div class="card border-0 shadow-sm {% if tema == 'exu' %}bg-light{% else %}bg-body-tertiary{% endif %} h-100 position-relative">
              <div class="card-body p-3 text-start">
                <!-- nome do medium de linha: o id fica em data-medium-id, NÃO exibimos o id -->
                <div class="fw-semibold text-dark" style="font-size: 0.95rem;">
                  <span class="nome-medium" data-medium-id="{{ f.medium_de_linha.id|default:'' }}">{{ f.medium_de_linha.nome|default:"—" }}</span>
                </div>

                <div class="text-muted" style="font-size: 0.85rem;">
                  {% if f.status|lower == 'vaga' %}
                    <button class="btn btn-sm btn-success btn-assumir" data-funcao="{{ f.id }}" style="font-size: 0.8rem;">Assumir</button>
                  {% else %}
                    <!-- pessoa atribuída: id no atributo, nome visível apenas como texto -->
                    <span class="nome-medium" data-medium-id="{{ f.pessoa.id|default:'' }}">{{ f.pessoa.nome|default:"—" }}</span>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-muted fst-italic">Nenhum cambone cadastrado.</p>
    {% endif %}
  </section>

  <hr class="my-4" style="border-color:{% if tema == 'exu' %}#660000{% else %}#ccc{% endif %};">

  <!-- BLOCO ORGANIZAÇÃO -->
  <section class="mb-5">
    <h4 class="mb-3"
        style="font-size: 1.3rem; font-weight: 600;
               color:{% if tema == 'exu' %}#b00000{% else %}#2e2e2e{% endif %};">
      Organização
    </h4>

    {% if organizacao %}
      <div class="row g-3">
        {% for f in organizacao %}
          <div id="card-{{ f.chave }}" data-funcao="{{ f.chave }}" data-pessoa="{{ f.pessoa.id|default:'' }}" class="col-6 col-md-4 col-lg-3">
            <div class="card border-0 shadow-sm {% if tema == 'exu' %}bg-light{% else %}bg-body-tertiary{% endif %} h-100 position-relative">
              {% if f.status|lower == 'vaga' %}
                <span class="badge bg-danger position-absolute" style="right:10px; top:10px; font-size:0.7rem;">Vago</span>
              {% endif %}
              <div class="card-body p-3 text-start">
                <div class="fw-semibold text-dark" style="font-size:0.95rem;">{{ f.descricao|default:f.tipo }}</div>
                <div class="text-muted" style="font-size:0.85rem;">
                  {% if f.status|lower == 'vaga' %}
                    <button class="btn btn-sm btn-success btn-assumir" data-funcao="{{ f.id }}" style="font-size:0.8rem;">Assumir</button>
                  {% else %}
                    <!-- pessoa atribuída com data-medium-id (oculto) -->
                    <span class="nome-medium" data-medium-id="{{ f.pessoa.id|default:'' }}">{{ f.pessoa.nome|default:"—" }}</span>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-muted fst-italic">Nenhuma função de organização cadastrada.</p>
    {% endif %}
  </section>

  <hr class="my-4" style="border-color:{% if tema == 'exu' %}#660000{% else %}#ccc{% endif %};">

  <!-- BLOCO LIMPEZA -->
  <section class="mb-5">
    <h4 class="mb-3"
        style="font-size: 1.3rem; font-weight: 600;
               color:{% if tema == 'exu' %}#b00000{% else %}#2e2e2e{% endif %};">
      Limpeza
    </h4>

    {% if limpeza %}
      <div class="row g-3">
        {% for f in limpeza %}
          <div id="card-{{ f.chave }}" data-funcao="{{ f.chave }}" data-pessoa="{{ f.pessoa.id|default:'' }}" class="col-6 col-md-4 col-lg-3">
            <div class="card border-0 shadow-sm {% if tema == 'exu' %}bg-light{% else %}bg-body-tertiary{% endif %} h-100 position-relative">
              {% if f.status|lower == 'vaga' %}
                <span class="badge bg-danger position-absolute" style="right:10px; top:10px; font-size:0.7rem;">Vago</span>
              {% endif %}
              <div class="card-body p-3 text-start">
                <div class="fw-semibold text-dark" style="font-size:0.95rem;">Limpeza</div>
                <div class="text-muted" style="font-size:0.85rem;">
                  {% if f.status|lower == 'vaga' %}
                    <button class="btn btn-sm btn-success btn-assumir" data-funcao="{{ f.id }}" style="font-size:0.8rem;">Assumir</button>
                  {% else %}
                    <!-- pessoa atribuída com data-medium-id (oculto) -->
                    <span class="nome-medium" data-medium-id="{{ f.pessoa.id|default:'' }}">{{ f.pessoa.nome|default:"—" }}</span>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-muted fst-italic">Nenhuma função de limpeza cadastrada.</p>
    {% endif %}
  </section>

  <p class="mt-4 text-center"
     style="font-size:0.95rem; color:{% if tema == 'exu' %}#d0d0d0{% else %}#444{% endif %};">
    Médiuns sem função definida devem colaborar com os demais.
  </p>
</div>

<!-- ✅ Toast -->
<div id="toast-funcao" class="toast-funcao"></div>

<style>

.toast-funcao.show {
  visibility: visible;
  opacity: 1;
}

  /* Barra de navegação */
{% if tema == 'exu' %}
.navbar {
  background: linear-gradient(to right, #000000, #4d0000, #990000);
}
{% else %}
.navbar {
  background: linear-gradient(to right, #002147, #6e9cb9, #A4D2E8);
}
{% endif %}
.navbar a, .navbar-brand, .navbar-nav .nav-link {
  color: #fff !important;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const csrftoken = document.cookie.match('(^|;)\\s*csrftoken\\s*=\\s*([^;]+)')?.pop();
  const toast = document.getElementById('toast-funcao');

  const mediumId = "{{ medium_logado.id|default:'' }}";
  const mediumNome = "{{ medium_logado.nome|default:user.nome|escapejs }}";

  console.debug("[INIT] medium_logado:", { id: mediumId, nome: mediumNome });

  function showToast(msg, color='#198754') {
    toast.textContent = msg;
    toast.style.backgroundColor = color;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 1800);
  }

  function renderOwned(card) {
  const meta = card.querySelector('.text-muted');
  if (!meta) return;
  console.debug("[renderOwned] Atualizando card", card.dataset.funcao, "para médium", mediumId);

  meta.innerHTML = `
    <div class="d-flex align-items-center justify-content-start">
      <span class="nome-medium me-1" data-medium-id="${mediumId}" style="font-weight:500;">${mediumNome}</span>
      <button class="btn btn-link text-danger btn-desistir p-0 ms-1"
              data-funcao="${card.dataset.funcao}"
              title="Desistir"
              style="font-size:0.9rem; line-height:1;">
        <i class="bi bi-x-circle"></i>
      </button>
    </div>`;
  
  card.dataset.pessoa = mediumId;
}

  function renderVacant(card) {
    const meta = card.querySelector('.text-muted');
    if (!meta) return;
    console.debug("[renderVacant] Liberando card", card.dataset.funcao);
    meta.innerHTML = `<button class="btn btn-sm btn-success btn-assumir" data-funcao="${card.dataset.funcao}" style="font-size:0.8rem;">Assumir</button>`;
    card.dataset.pessoa = '';
  }

  // Inicial: mostra botão “Desistir” nos cards já assumidos
  document.querySelectorAll('.nome-medium').forEach(span => {
  const mid = span.dataset.mediumId || '';
  const card = span.closest('[data-funcao]');
  if (mid && card && mid.toString() === mediumId.toString()) {
    console.debug("[INIT] Card pertencente ao médium logado encontrado:", card.dataset.funcao);
    if (!card.querySelector('.btn-desistir')) {
      span.insertAdjacentHTML('afterend', `
        <button class="btn btn-link text-danger btn-desistir p-0 ms-1"
                data-funcao="${card.dataset.funcao}"
                title="Desistir"
                style="font-size:0.9rem; line-height:1;">
          <i class="bi bi-x-circle"></i>
        </button>`);
    }
  }
});

  // ASSUMIR
  document.addEventListener('click', e => {
    const btn = e.target.closest('.btn-assumir');
    if (!btn) return;
    const funcaoId = btn.dataset.funcao;
    const card = document.getElementById(`card-${funcaoId}`);
    if (!card) return;

    console.debug("[CLICK] Assumir função:", funcaoId, "→ médium:", mediumId);

    renderOwned(card);
    showToast('Assumindo função...', '#0d6efd');

    fetch("{% url 'gira:assumir_funcao' %}", {
      method: 'POST',
      headers: {'X-CSRFToken': csrftoken, 'Content-Type':'application/x-www-form-urlencoded'},
      body: new URLSearchParams({ funcao_chave: funcaoId })
    })
    .then(r => r.json())
    .then(d => {
      console.debug("[RESPONSE] Assumir:", d);
      if (d.status !== 'ok') {
        renderVacant(card);
        showToast(d.mensagem || 'Erro ao assumir', '#dc3545');
      } else {
        showToast(d.mensagem || 'Função assumida', '#198754');
      }
    })
    .catch(err => {
      console.debug("[ERROR] Assumir:", err);
      renderVacant(card);
      showToast('Erro de rede ao assumir', '#dc3545');
    });
  });

  // DESISTIR
  document.addEventListener('click', e => {
    const btn = e.target.closest('.btn-desistir');
    if (!btn) return;
    const funcaoId = btn.dataset.funcao;
    const card = document.getElementById(`card-${funcaoId}`);
    if (!card) return;

    console.debug("[CLICK] Desistir função:", funcaoId, "→ médium:", mediumId);

    renderVacant(card);
    showToast('Desistindo da função...', '#ffc107');

    fetch("{% url 'gira:desistir_funcao' %}", {
      method: 'POST',
      headers: {'X-CSRFToken': csrftoken, 'Content-Type':'application/x-www-form-urlencoded'},
      body: new URLSearchParams({funcao_id: funcaoId})
    })
    .then(r => r.json())
    .then(d => {
      console.debug("[RESPONSE] Desistir:", d);
      if (d.status !== 'ok') {
        renderOwned(card);
        showToast(d.mensagem || 'Erro ao desistir', '#dc3545');
      } else {
        showToast(d.mensagem || 'Função liberada', '#0dcaf0');
      }
    })
    .catch(err => {
      console.debug("[ERROR] Desistir:", err);
      renderOwned(card);
      showToast('Erro de rede ao desistir', '#dc3545');
    });
  });

});

  // --- CONTROLE DO CARROSSEL DE GIRAS ---
document.addEventListener('DOMContentLoaded', () => {
  const prevBtn = document.getElementById('prevGira');
  const nextBtn = document.getElementById('nextGira');
  const giraIdAtual = "{{ gira.id }}";
  const tema = "{{ tema }}";

  // Lista de giras (gerado no backend)
  const giras = {{ giras_json|safe }};
  let index = giras.findIndex(g => g.id === parseInt(giraIdAtual));

  // Cores do tema
  const corAtiva = tema === 'exu' ? '#b00000' : '#0072bb';
  const corInativa = '#cccccc';

  function atualizarBotoes() {
    prevBtn.disabled = (index <= 0);
    nextBtn.disabled = (index >= giras.length - 1);
    prevBtn.style.color = prevBtn.disabled ? corInativa : corAtiva;
    nextBtn.style.color = nextBtn.disabled ? corInativa : corAtiva;
  }

  function navegar(offset) {
    const novo = index + offset;
    if (novo >= 0 && novo < giras.length) {
      const giraDestino = giras[novo];
      window.location.href = `/funcoes_dev/${giraDestino.id}/`;
    }
  }

  if (prevBtn && nextBtn) {
    prevBtn.addEventListener('click', () => navegar(-1));
    nextBtn.addEventListener('click', () => navegar(1));
    atualizarBotoes();
  }

  // Swipe (mobile)
  let touchStartX = 0;
  let touchEndX = 0;
  document.addEventListener('touchstart', e => touchStartX = e.changedTouches[0].screenX);
  document.addEventListener('touchend', e => {
    touchEndX = e.changedTouches[0].screenX;
    const diff = touchEndX - touchStartX;
    if (Math.abs(diff) > 60) {
      if (diff > 0) navegar(-1);
      else navegar(1);
    }
  });
});


</script>

{% endblock %}

{% extends 'gira/base.html' %}

{% block content %}
<div class="container my-4">

  {% if gira %}
    <div class="mb-4 text-start">
      <p class="mb-1"
         style="font-size: 0.95rem; font-weight: 500;
                color: {% if tema == 'exu' %}#ff4d4d{% else %}#0072bb{% endif %};">
        {{ gira.data_hora|date:"d/m/Y H:i" }}
      </p>
      <h2 class="mb-2"
          style="font-size: 1.6rem; font-weight: 700;
                 color: {% if tema == 'exu' %}#c00000{% else %}#222222{% endif %};">
        {{ gira.linha }}
      </h2>
      <p class="mb-0"
         style="font-size: 0.95rem;
                color: {% if tema == 'exu' %}#d0d0d0{% else %}#444444{% endif %};">
        Escolha ou visualize as funções assumidas para esta gira.<br>
        Cambones e responsáveis de cada área estão listados abaixo.
      </p>
    </div>
  {% else %}
    <div class="alert alert-warning">Nenhuma gira encontrada.</div>
  {% endif %}

  <hr class="my-4" style="border-color: {% if tema == 'exu' %}#660000{% else %}#cccccc{% endif %};">

  <!-- BLOCO: CAMBONES -->
  <section class="mb-5">
    <h4 class="mb-3"
        style="font-size: 1.3rem; font-weight: 600;
               color: {% if tema == 'exu' %}#b00000{% else %}#2e2e2e{% endif %};">
      Cambones
    </h4>

    {% if cambones %}
      <div class="row g-3">
        {% for f in cambones %}
          <div class="col-6 col-md-4 col-lg-3">
            <div id="card-{{ f.id }}" class="card border-0 shadow-sm {% if tema == 'exu' %}bg-light{% else %}bg-body-tertiary{% endif %} h-100">
              <div class="card-body p-3 text-start">
                <div class="fw-semibold text-dark" style="font-size: 0.95rem;">
                  {{ f.medium_de_linha.nome|default:"—" }}
                  <!-- mostra o id do medium_de_linha para debug -->
                  <small class="text-muted" style="font-size:0.75rem; margin-left:6px;">(#{{ f.medium_de_linha.id|default:'-' }})</small>
                </div>

                <div class="text-muted" style="font-size: 0.85rem;">
                  <!-- Nome do responsável (aqui f.pessoa pode ser medium ou user) -->
                  {% if f.pessoa_medium %}
                    {{ f.pessoa_medium.nome }}
                    <small style="font-size:0.75rem; color:#666;">(m#{{ f.pessoa_medium.id }})</small>
                  {% elif f.pessoa %}
                    {{ f.pessoa.nome }}
                    <small style="font-size:0.75rem; color:#666;">(u#{{ f.pessoa.id }})</small>
                  {% else %}
                    —
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-muted fst-italic">Nenhum cambone cadastrado.</p>
    {% endif %}
  </section>

  <hr class="my-4" style="border-color: {% if tema == 'exu' %}#660000{% else %}#cccccc{% endif %};">

  <!-- BLOCO: ORGANIZAÇÃO -->
  <section class="mb-5">
    <h4 class="mb-3"
        style="font-size: 1.3rem; font-weight: 600;
               color: {% if tema == 'exu' %}#b00000{% else %}#2e2e2e{% endif %};">
      Organização
    </h4>

    {% if organizacao %}
      <div class="row g-3">
        {% for f in organizacao %}
          <div class="col-6 col-md-4 col-lg-3">
            <div id="card-{{ f.id }}" class="card border-0 shadow-sm {% if tema == 'exu' %}bg-light{% else %}bg-body-tertiary{% endif %} h-100 position-relative">
              {% if f.status|lower == 'vaga' %}
                <span class="badge bg-danger position-absolute" style="right:10px; top:10px; font-size: 0.7rem;">Vago</span>
              {% endif %}
              <div class="card-body p-3 text-start">
                <div class="fw-semibold text-dark" style="font-size: 0.95rem;">
                  {{ f.display_descricao|default:f.descricao|default:f.tipo }}
                </div>
                <div class="text-muted" style="font-size: 0.85rem;">
                  {% comment %}
                    Exibição/controle do botão:
                      - se vaga: botão Assumir
                      - se preenchida e pessoa_medium == medium_logado -> mostrar nome + botão desistir
                      - else -> mostrar nome (sem botão)
                  {% endcomment %}

                  {% if f.status|lower == 'vaga' %}
                    <button class="btn btn-sm btn-success btn-assumir" data-funcao="{{ f.id }}" style="font-size: 0.8rem;">Assumir</button>

                  {% elif f.pessoa_medium and medium_logado and f.pessoa_medium.id == medium_logado.id %}
                    <!-- você é o médium que está nessa função: mostra botão desistir -->
                    <span>{{ f.pessoa_medium.nome }}</span>
                    <small style="font-size:0.75rem; color:#666;">(m#{{ f.pessoa_medium.id }})</small>
                    <button class="btn btn-link text-danger btn-desistir" data-funcao="{{ f.id }}" title="Desistir" style="font-size: 0.8rem; padding:0; margin-left:5px;">
                      <i class="bi bi-x-circle"></i>
                    </button>

                  {% elif f.pessoa %}
                    <!-- se f.pessoa existir mas não for medium_logado -->
                    {{ f.pessoa.nome }}
                    <small style="font-size:0.75rem; color:#666;">(u#{{ f.pessoa.id }})</small>

                  {% else %}
                    -
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-muted fst-italic">Nenhuma função de organização cadastrada.</p>
    {% endif %}
  </section>

  <hr class="my-4" style="border-color: {% if tema == 'exu' %}#660000{% else %}#cccccc{% endif %};">

  <!-- BLOCO: LIMPEZA -->
  <section class="mb-5">
    <h4 class="mb-3" style="font-size: 1.3rem; font-weight: 600; color: {% if tema == 'exu' %}#b00000{% else %}#2e2e2e{% endif %};">
      Limpeza
    </h4>

    {% if limpeza %}
      <div class="row g-3">
        {% for f in limpeza %}
          <div class="col-6 col-md-4 col-lg-3">
            <div id="card-{{ f.id }}" class="card border-0 shadow-sm {% if tema == 'exu' %}bg-light{% else %}bg-body-tertiary{% endif %} h-100 position-relative">
              {% if f.status|lower == 'vaga' %}
                <span class="badge bg-danger position-absolute" style="right:10px; top:10px; font-size: 0.7rem;">Vago</span>
              {% endif %}
              <div class="card-body p-3 text-start">
                <div class="fw-semibold text-dark" style="font-size: 0.95rem;">Limpeza</div>
                <div class="text-muted" style="font-size: 0.85rem;">
                  {% if f.status|lower == 'vaga' %}
                    <button class="btn btn-sm btn-success btn-assumir" data-funcao="{{ f.id }}" style="font-size: 0.8rem;">Assumir</button>

                  {% elif f.pessoa_medium and medium_logado and f.pessoa_medium.id == medium_logado.id %}
                    <span>{{ f.pessoa_medium.nome }}</span>
                    <small style="font-size:0.75rem; color:#666;">(m#{{ f.pessoa_medium.id }})</small>
                    <button class="btn btn-link text-danger btn-desistir" data-funcao="{{ f.id }}" title="Desistir" style="font-size: 0.8rem; padding:0; margin-left:5px;">
                      <i class="bi bi-x-circle"></i>
                    </button>

                  {% elif f.pessoa %}
                    {{ f.pessoa.nome }}
                    <small style="font-size:0.75rem; color:#666;">(u#{{ f.pessoa.id }})</small>

                  {% else %}
                    -
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-muted fst-italic">Nenhuma função de limpeza cadastrada.</p>
    {% endif %}
  </section>

  <hr class="my-4" style="border-color: {% if tema == 'exu' %}#660000{% else %}#cccccc{% endif %};">

  <p class="mt-4 text-center"
     style="font-size: 0.95rem;
            color: {% if tema == 'exu' %}#d0d0d0{% else %}#444444{% endif %};">
    Médiuns sem função definida na gira devem permanecer atentos, colaborar com os demais 
    e apoiar a assistência quando necessário.
  </p>
</div>

<!-- Balão temporário -->
<div id="toast-funcao" class="toast-funcao">Função assumida com sucesso!</div>

<style>
.toast-funcao { visibility:hidden; min-width:300px; background:#333; color:#fff; text-align:center; border-radius:8px; padding:10px; position:fixed; left:50%; bottom:40px; transform:translateX(-50%); z-index:9999; opacity:0; transition:opacity .4s, visibility .4s;}
.toast-funcao.show { visibility:visible; opacity:1; }

{% if tema == 'exu' %}
.navbar { background: linear-gradient(to right, #000000, #4d0000, #990000); }
{% else %}
.navbar { background: linear-gradient(to right, #002147, #6e9cb9, #A4D2E8); }
{% endif %}
.navbar a, .navbar-brand, .navbar-nav .nav-link { color: #fff !important; }
</style>

<script>
/* script curto para toasts - otimistic UI já implementado separadamente */
function showToast(msg, tipo='info'){ const t=document.getElementById('toast-funcao'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2400); }
</script>

{% endblock %}

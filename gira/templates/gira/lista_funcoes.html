{% extends 'gira/base.html' %}

{% block content %}
<div class="container my-4">

  {% if gira %}
    <div class="mb-4 text-start">
      <p class="mb-1"
         style="font-size: 0.95rem; font-weight: 500;
                color: {% if tema == 'exu' %}#ff4d4d{% else %}#0072bb{% endif %};">
        {{ gira.data_hora|date:"d/m/Y H:i" }}
      </p>
      <h2 class="mb-2"
          style="font-size: 1.6rem; font-weight: 700;
                 color: {% if tema == 'exu' %}#c00000{% else %}#222222{% endif %};">
        {{ gira.linha }}
      </h2>
      <p class="mb-0"
         style="font-size: 0.95rem;
                color: {% if tema == 'exu' %}#d0d0d0{% else %}#444444{% endif %};">
        Escolha ou visualize as funções assumidas para esta gira.<br>
        Cambones e responsáveis de cada área estão listados abaixo.
      </p>
    </div>
  {% else %}
    <div class="alert alert-warning">Nenhuma gira encontrada.</div>
  {% endif %}

  <hr class="my-4"
      style="border-color: {% if tema == 'exu' %}#660000{% else %}#cccccc{% endif %};">

  <!-- BLOCO: CAMBONES -->
  <section class="mb-5">
    <h4 class="mb-3"
        style="font-size: 1.3rem; font-weight: 600;
               color: {% if tema == 'exu' %}#b00000{% else %}#2e2e2e{% endif %};">
      Cambones
    </h4>

    {% if cambones %}
      <div class="row g-3">
        {% for f in cambones %}
          <div class="col-6 col-md-4 col-lg-3">
            <div class="card border-0 shadow-sm {% if tema == 'exu' %}bg-light{% else %}bg-body-tertiary{% endif %} h-100">
              <div class="card-body p-3 text-start">
                <div class="fw-semibold text-dark" style="font-size: 0.95rem;">
                  {{ f.medium_de_linha.nome|default:"—" }}
                </div>
                <div class="text-muted" style="font-size: 0.85rem;">
                  {{ f.pessoa.nome|default:"—" }}
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-muted fst-italic">Nenhum cambone cadastrado.</p>
    {% endif %}
  </section>

  <hr class="my-4" style="border-color: {% if tema == 'exu' %}#660000{% else %}#cccccc{% endif %};">

  <!-- BLOCO: ORGANIZAÇÃO -->
  <section class="mb-5">
    <h4 class="mb-3"
        style="font-size: 1.3rem; font-weight: 600;
               color: {% if tema == 'exu' %}#b00000{% else %}#2e2e2e{% endif %};">
      Organização
    </h4>

    {% if organizacao %}
      <div class="row g-3">
        {% for f in organizacao %}
          <div class="col-6 col-md-4 col-lg-3">
            <div class="card border-0 shadow-sm {% if tema == 'exu' %}bg-light{% else %}bg-body-tertiary{% endif %} h-100 position-relative">
              {% if f.status|lower == 'vaga' %}
                <span class="badge bg-danger position-absolute"
                      style="right:10px; top:10px; font-size: 0.7rem;">Vago</span>
              {% endif %}
              <div class="card-body p-3 text-start">
                <div class="fw-semibold text-dark" style="font-size: 0.95rem;">
                  {{ f.descricao|default:f.tipo }}
                </div>

                <div class="text-muted" style="font-size: 0.85rem;">
                  {% if f.status|lower == 'vaga' %}
                    <button class="btn btn-sm btn-success btn-assumir"
                            data-funcao="{{ f.id }}"
                            style="font-size: 0.8rem;">Assumir</button>
                  {% else %}
                    {% if f.pessoa and f.pessoa.id == user.medium.id %}
                      <span>{{ f.pessoa.nome|default:"—" }}</span>
                      <button class="btn btn-link text-danger btn-desistir"
                              data-funcao="{{ f.id }}"
                              title="Desistir"
                              style="font-size: 0.8rem; padding:0; margin-left:5px;">
                        <i class="bi bi-x-circle"></i>
                      </button>
                    {% else %}
                      {{ f.pessoa.nome|default:"-" }}
                    {% endif %}
                  {% endif %}
                </div>

              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-muted fst-italic">Nenhuma função de organização cadastrada.</p>
    {% endif %}
  </section>

  <hr class="my-4" style="border-color: {% if tema == 'exu' %}#660000{% else %}#cccccc{% endif %};">

  <!-- BLOCO: LIMPEZA -->
  <section class="mb-5">
    <h4 class="mb-3"
        style="font-size: 1.3rem; font-weight: 600;
               color: {% if tema == 'exu' %}#b00000{% else %}#2e2e2e{% endif %};">
      Limpeza
    </h4>

    {% if limpeza %}
      <div class="row g-3">
        {% for f in limpeza %}
          <div class="col-6 col-md-4 col-lg-3">
            <div class="card border-0 shadow-sm {% if tema == 'exu' %}bg-light{% else %}bg-body-tertiary{% endif %} h-100 position-relative">
              {% if f.status|lower == 'vaga' %}
                <span class="badge bg-danger position-absolute"
                      style="right:10px; top:10px; font-size: 0.7rem;">Vago</span>
              {% endif %}
              <div class="card-body p-3 text-start">
                <div class="fw-semibold text-dark" style="font-size: 0.95rem;">Limpeza</div>

                <div class="text-muted" style="font-size: 0.85rem;">
                  {% if f.status|lower == 'vaga' %}
                    <button class="btn btn-sm btn-success btn-assumir"
                            data-funcao="{{ f.id }}"
                            style="font-size: 0.8rem;">Assumir</button>
                  {% else %}
                    {% if f.pessoa and f.pessoa.id == user.medium.id %}
                      <span>{{ f.pessoa.nome|default:"—" }}</span>
                      <button class="btn btn-link text-danger btn-desistir"
                              data-funcao="{{ f.id }}"
                              title="Desistir"
                              style="font-size: 0.8rem; padding:0; margin-left:5px;">
                        <i class="bi bi-x-circle"></i>
                      </button>
                    {% else %}
                      {{ f.pessoa.nome|default:"-" }}
                    {% endif %}
                  {% endif %}
                </div>

              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-muted fst-italic">Nenhuma função de limpeza cadastrada.</p>
    {% endif %}
  </section>

  <hr class="my-4" style="border-color: {% if tema == 'exu' %}#660000{% else %}#cccccc{% endif %};">

  <p class="mt-4 text-center"
     style="font-size: 0.95rem;
            color: {% if tema == 'exu' %}#d0d0d0{% else %}#444444{% endif %};">
    Médiuns sem função definida na gira devem permanecer atentos, colaborar com os demais 
    e apoiar a assistência quando necessário.
  </p>
</div>

<!-- ✅ Balão temporário -->
<div id="toast-funcao" class="toast-funcao">Função assumida com sucesso!</div>

<style>
.toast-funcao {
  visibility: hidden;
  min-width: 300px;
  background-color: #333;
  color: #fff;
  text-align: center;
  border-radius: 8px;
  padding: 10px;
  position: fixed;
  left: 50%;
  bottom: 40px;
  transform: translateX(-50%);
  z-index: 9999;
  opacity: 0;
  transition: opacity 0.5s, visibility 0.5s;
}
.toast-funcao.show {
  visibility: visible;
  opacity: 1;
}

/* Barra de navegação */
{% if tema == 'exu' %}
.navbar {
  background: linear-gradient(to right, #000000, #4d0000, #990000);
}
{% else %}
.navbar {
  background: linear-gradient(to right, #002147, #6e9cb9, #A4D2E8);
}
{% endif %}
.navbar a, .navbar-brand, .navbar-nav .nav-link {
  color: #fff !important;
}
</style>

<script>
function getCookie(name) {
  const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
  return v ? v.pop() : '';
}
const csrftoken = getCookie('csrftoken');

document.addEventListener('DOMContentLoaded', function() {
  function mostrarMensagem(msg, tipo='info') {
    const alerta = document.createElement('div');
    alerta.className = `alert alert-${tipo} position-fixed bottom-0 start-50 translate-middle-x mb-3`;
    alerta.style.zIndex = 1055;
    alerta.textContent = msg;
    document.body.appendChild(alerta);
    setTimeout(() => alerta.remove(), 2000);
  }

  // Função auxiliar: bloqueia duplo clique e dá resposta imediata
  function bloquearBotao(btn, textoTemp) {
    btn.disabled = true;
    const antigo = btn.textContent;
    btn.textContent = textoTemp;
    btn.style.opacity = "0.7";
    return () => {
      btn.disabled = false;
      btn.textContent = antigo;
      btn.style.opacity = "1";
    };
  }

  // ✅ Assumir função (resposta instantânea + reload suave)
  document.querySelectorAll('.btn-assumir').forEach(btn => {
    btn.addEventListener('click', () => {
      const liberar = bloquearBotao(btn, "Assumindo...");
      const funcao_id = btn.dataset.funcao;

      fetch("{% url 'gira:assumir_funcao' %}", {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken,
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: new URLSearchParams({funcao_id})
      })
      .then(r => r.json())
      .then(d => {
        mostrarMensagem(d.mensagem, d.status === 'ok' ? 'success' : 'danger');
        if (d.status === 'ok') {
          btn.textContent = "Assumido ✓";
          btn.classList.replace('btn-success', 'btn-secondary');
          setTimeout(() => location.reload(), 800);
        } else liberar();
      })
      .catch(() => {
        mostrarMensagem('Erro ao assumir função', 'danger');
        liberar();
      });
    });
  });

  // ✅ Desistir função (resposta instantânea também)
  document.querySelectorAll('.btn-desistir').forEach(btn => {
    btn.addEventListener('click', () => {
      const liberar = bloquearBotao(btn, "Saindo...");
      const funcao_id = btn.dataset.funcao;

      fetch("{% url 'gira:desistir_funcao' %}", {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken,
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: new URLSearchParams({funcao_id})
      })
      .then(r => r.json())
      .then(d => {
        mostrarMensagem(d.mensagem, d.status === 'ok' ? 'warning' : 'danger');
        if (d.status === 'ok') {
          btn.closest('.card-body').style.opacity = '0.6';
          setTimeout(() => location.reload(), 700);
        } else liberar();
      })
      .catch(() => {
        mostrarMensagem('Erro ao desistir da função', 'danger');
        liberar();
      });
    });
  });
});
</script>

{% endblock %}
